image:
  - melezhik/sparrow:ubuntu_arm
    
tasks:
  -
    name: test
    default: true
    language: Bash
    code: |
      set -e
      set -x
      s6 --index-update
      cd source 
      tomty --profile=ci --all --show-failed --color 
    depends:
      -
        name: install-zef-deps
      -
        name: install-deps
      -
        name: install-powershell
  -
    name: install-zef-deps
    language: Bash
    code: |
      set -e
      cd source
      zef install . --/test

  -
    name: install-deps
    language: Bash
    code: |
      set -e
      sudo apt-get update;
      sudo apt-get install -yq ruby-dev ruby-bundler \
      python3-pip python3-dev python3-pytest \
      perlutil carton

  - name: install-powershell
    language: Bash
    code: |
      # Install pre-requisite packages.
      sudo apt-get install -y wget apt-transport-https software-properties-common
      # Download the Microsoft repository GPG keys
      wget -q "https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb"
      # Register the Microsoft repository GPG keys
      sudo dpkg -i packages-microsoft-prod.deb
      # Delete the the Microsoft repository GPG keys file
      rm packages-microsoft-prod.deb
      # Update the list of packages after we added packages.microsoft.com
      sudo apt-get update
      # Install PowerShell
      sudo apt-get install -y powershell
      pwsh --version

followup_job: .sparrow/publish.yaml
